{
    "info": {
        "_postman_id": "c4d8f6a2-9b1e-4c7f-8e3a-5f2d1a8b6c9e",
        "name": "Contact API Tests",
        "description": "Test API contact với các scenarios khác nhau (data-driven)",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
        "_exporter_id": "38685069"
    },
    "item": [
        {
            "name": "Send Contact Message (Data-driven)",
            "event": [
                {
                    "listen": "test",
                    "script": {
                        "exec": [
                            "// Lấy expected status code từ CSV data",
                            "const expectedStatus = pm.iterationData.get(\"expected_status\");",
                            "",
                            "// Kiểm tra response có phải JSON không",
                            "pm.test(\"Response is valid\", function () {",
                            "    // Nếu response là HTML (500 error), skip JSON parse",
                            "    if (pm.response.headers.get('Content-Type') && pm.response.headers.get('Content-Type').includes('text/html')) {",
                            "        pm.expect(pm.response.code).to.be.oneOf([500, 404, 401]);",
                            "        return;",
                            "    }",
                            "    pm.response.to.be.json;",
                            "});",
                            "",
                            "// Chỉ test status code nếu expected status hợp lệ",
                            "if (expectedStatus && !isNaN(Number(expectedStatus))) {",
                            "    pm.test(\"Status code matches expected\", function () {",
                            "        pm.response.to.have.status(Number(expectedStatus));",
                            "    });",
                            "} else {",
                            "    pm.test(\"Status code is documented\", function () {",
                            "        pm.expect(pm.response.code).to.be.oneOf([200, 201, 422, 401, 404, 500]);",
                            "    });",
                            "}",
                            "",
                            "// Chỉ parse JSON nếu không phải HTML response",
                            "let responseData;",
                            "try {",
                            "    responseData = pm.response.json();",
                            "} catch (e) {",
                            "    console.log('Response is not JSON, probably HTML error page');",
                            "    return;",
                            "}",
                            "",
                            "// Nếu thành công (201), kiểm tra các trường bắt buộc",
                            "if (pm.response.code === 201) {",
                            "    pm.test(\"Response has required fields for success\", function () {",
                            "        pm.expect(responseData).to.be.an('object');",
                            "        pm.expect(responseData).to.have.property('id');",
                            "        pm.expect(responseData).to.have.property('first_name');",
                            "        pm.expect(responseData).to.have.property('last_name');",
                            "        pm.expect(responseData).to.have.property('email');",
                            "        pm.expect(responseData).to.have.property('subject');",
                            "        pm.expect(responseData).to.have.property('message');",
                            "    });",
                            "    pm.test(\"ID must be a positive integer\", function () {",
                            "        pm.expect(responseData.id).to.exist.and.to.be.a('number').and.to.be.above(0);",
                            "    });",
                            "    pm.test(\"Email format should be valid\", function () {",
                            "        pm.expect(responseData.email).to.match(/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/);",
                            "    });",
                            "    // Lưu message ID để sử dụng cho các test khác",
                            "    pm.environment.set(\"message_id\", responseData.id);",
                            "} else if (pm.response.code === 422) {",
                            "    // Validation error - API có thể trả về format khác nhau",
                            "    pm.test(\"Response contains validation information\", function () {",
                            "        pm.expect(responseData).to.be.an('object');",
                            "        // API có thể trả về errors hoặc message hoặc các field riêng lẻ",
                            "        const hasErrors = responseData.hasOwnProperty('errors');",
                            "        const hasMessage = responseData.hasOwnProperty('message');",
                            "        const hasFieldErrors = Object.keys(responseData).some(key => ",
                            "            ['email', 'first_name', 'last_name', 'subject', 'message'].includes(key)",
                            "        );",
                            "        pm.expect(hasErrors || hasMessage || hasFieldErrors).to.be.true;",
                            "    });",
                            "} else if (pm.response.code === 500) {",
                            "    pm.test(\"Server error acknowledged\", function () {",
                            "        pm.expect(pm.response.code).to.equal(500);",
                            "    });",
                            "} else if (pm.response.code >= 400) {",
                            "    pm.test(\"Error response has information\", function () {",
                            "        pm.expect(responseData).to.be.an('object');",
                            "        const hasMessage = responseData.hasOwnProperty('message');",
                            "        const hasError = responseData.hasOwnProperty('error');",
                            "        pm.expect(hasMessage || hasError).to.be.true;",
                            "    });",
                            "}"
                        ],
                        "type": "text/javascript"
                    }
                }
            ],
            "request": {
                "method": "POST",
                "header": [
                    {
                        "key": "Content-Type",
                        "value": "application/json"
                    }
                ],
                "body": {
                    "mode": "raw",
                    "raw": "{\n  \"first_name\": \"{{first_name}}\",\n  \"last_name\": \"{{last_name}}\",\n  \"email\": \"{{email}}\",\n  \"subject\": \"{{subject}}\",\n  \"message\": \"{{message}}\"\n}"
                },
                "url": {
                    "raw": "{{base_url}}/messages",
                    "host": ["{{base_url}}"],
                    "path": ["messages"]
                }
            },
            "response": []
        },
        {
            "name": "Get All Contact Messages (Data-driven)",
            "event": [
                {
                    "listen": "test",
                    "script": {
                        "exec": [
                            "// GET request thường cần authentication, nên expect 401 là bình thường",
                            "pm.test(\"Status code is as expected for GET request\", function () {",
                            "    // GET /messages thường cần admin token, nên 401 là expected",
                            "    pm.expect(pm.response.code).to.be.oneOf([200, 401]);",
                            "});",
                            "",
                            "// Nếu thành công (200), kiểm tra structure của response",
                            "if (pm.response.code === 200) {",
                            "    const responseData = pm.response.json();",
                            "    pm.test(\"Response should be an object with data property\", function () {",
                            "        pm.expect(responseData).to.be.an('object');",
                            "        pm.expect(responseData).to.have.property('data');",
                            "    });",
                            "    pm.test(\"Data should be an array\", function () {",
                            "        pm.expect(responseData.data).to.be.an('array');",
                            "    });",
                            "    // Nếu có messages, kiểm tra structure của từng message",
                            "    if (responseData.data.length > 0) {",
                            "        pm.test(\"Each message has required fields\", function () {",
                            "            responseData.data.forEach(function(message) {",
                            "                pm.expect(message).to.have.all.keys('id', 'first_name', 'last_name', 'email', 'subject', 'message', 'status', 'created_at', 'updated_at');",
                            "            });",
                            "        });",
                            "    }",
                            "} else if (pm.response.code === 401) {",
                            "    // Expected behavior - GET messages requires authentication",
                            "    try {",
                            "        const responseData = pm.response.json();",
                            "        pm.test(\"Unauthorized response has message\", function () {",
                            "            pm.expect(responseData).to.be.an('object');",
                            "            pm.expect(responseData).to.have.property('message');",
                            "        });",
                            "    } catch (e) {",
                            "        pm.test(\"401 status received (authentication required)\", function () {",
                            "            pm.expect(pm.response.code).to.equal(401);",
                            "        });",
                            "    }",
                            "}"
                        ],
                        "type": "text/javascript"
                    }
                }
            ],
            "request": {
                "method": "GET",
                "header": [
                    {
                        "key": "Authorization",
                        "value": "Bearer {{auth_token}}",
                        "description": "Admin token required to view all messages"
                    }
                ],
                "url": {
                    "raw": "{{base_url}}/messages",
                    "host": ["{{base_url}}"],
                    "path": ["messages"]
                }
            },
            "response": []
        },
        {
            "name": "Update Contact Message Status (Data-driven)",
            "event": [
                {
                    "listen": "test",
                    "script": {
                        "exec": [
                            "// PUT request cần message_id và thường cần authentication",
                            "// 404 là expected nếu không có message_id hoặc message không tồn tại",
                            "pm.test(\"Status code is as expected for PUT request\", function () {",
                            "    pm.expect(pm.response.code).to.be.oneOf([200, 401, 404, 422]);",
                            "});",
                            "",
                            "// Nếu thành công (200), kiểm tra response data",
                            "if (pm.response.code === 200) {",
                            "    const responseData = pm.response.json();",
                            "    pm.test(\"Response has updated message data\", function () {",
                            "        pm.expect(responseData).to.be.an('object');",
                            "        pm.expect(responseData).to.have.property('id');",
                            "        pm.expect(responseData).to.have.property('status');",
                            "    });",
                            "    pm.test(\"Status should match the updated value\", function () {",
                            "        const expectedStatus = pm.iterationData.get(\"new_status\");",
                            "        if (expectedStatus) {",
                            "            pm.expect(responseData.status).to.equal(expectedStatus);",
                            "        }",
                            "    });",
                            "} else if (pm.response.code === 404) {",
                            "    // Expected - message không tồn tại hoặc URL không đúng",
                            "    try {",
                            "        const responseData = pm.response.json();",
                            "        pm.test(\"404 response has message\", function () {",
                            "            pm.expect(responseData).to.be.an('object');",
                            "            pm.expect(responseData).to.have.property('message');",
                            "        });",
                            "    } catch (e) {",
                            "        pm.test(\"404 status received (message not found)\", function () {",
                            "            pm.expect(pm.response.code).to.equal(404);",
                            "        });",
                            "    }",
                            "} else if (pm.response.code === 401) {",
                            "    // Expected - authentication required",
                            "    try {",
                            "        const responseData = pm.response.json();",
                            "        pm.test(\"401 response has message\", function () {",
                            "            pm.expect(responseData).to.be.an('object');",
                            "            pm.expect(responseData).to.have.property('message');",
                            "        });",
                            "    } catch (e) {",
                            "        pm.test(\"401 status received (authentication required)\", function () {",
                            "            pm.expect(pm.response.code).to.equal(401);",
                            "        });",
                            "    }",
                            "} else if (pm.response.code === 422) {",
                            "    // Validation error",
                            "    try {",
                            "        const responseData = pm.response.json();",
                            "        pm.test(\"422 response has validation info\", function () {",
                            "            pm.expect(responseData).to.be.an('object');",
                            "        });",
                            "    } catch (e) {",
                            "        pm.test(\"422 status received (validation error)\", function () {",
                            "            pm.expect(pm.response.code).to.equal(422);",
                            "        });",
                            "    }",
                            "}"
                        ],
                        "type": "text/javascript"
                    }
                }
            ],
            "request": {
                "method": "PUT",
                "header": [
                    {
                        "key": "Content-Type",
                        "value": "application/json"
                    },
                    {
                        "key": "Authorization",
                        "value": "Bearer {{auth_token}}",
                        "description": "Admin token required to update message status"
                    }
                ],
                "body": {
                    "mode": "raw",
                    "raw": "{\n  \"status\": \"{{new_status}}\"\n}"
                },
                "url": {
                    "raw": "{{base_url}}/messages/1/status",
                    "host": ["{{base_url}}"],
                    "path": ["messages", "1", "status"]
                }
            },
            "response": []
        }
    ],
    "variable": [
        {
            "key": "base_url",
            "value": "{{base_url}}"
        },
        {
            "key": "auth_token",
            "value": "{{auth_token}}"
        },
        {
            "key": "message_id",
            "value": "{{message_id}}"
        }
    ]
}
